name: CodeQL Security Demo - Manual Trigger

on:
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: true
        default: 'codeql-only'
        type: choice
        options:
        - 'codeql-only'
        - 'full-security'
        - 'gitleaks-only'

permissions:
  actions: read
  contents: read
  security-events: write

env:
  NODE_VERSION: '20.x'

jobs:
  codeql-demo:
    name: CodeQL Security Analysis (Manual Demo)
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: ${{ github.event.inputs.scan_type == 'codeql-only' || github.event.inputs.scan_type == 'full-security' }}
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript-typescript' ]
    steps:
      - name: ğŸ“‹ Demo Info
        run: |
          echo "ğŸ¯ DEMONSTRAÃ‡ÃƒO CODEQL MANUAL"
          echo "ğŸ” Tipo de scan: ${{ github.event.inputs.scan_type }}"
          echo "ğŸ“Š Linguagem: ${{ matrix.language }}"
          echo "âš ï¸  Vulnerabilidades esperadas:"
          echo "   - XSS via innerHTML/document.write"
          echo "   - Code Injection via eval()/Function()"
          echo "   - Prototype Pollution"
          echo "   - Hardcoded Secrets"

      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ” Mostrar arquivos com vulnerabilidades
        run: |
          echo "ğŸ“ ARQUIVOS COM VULNERABILIDADES PROPOSITAIS:"
          echo "1ï¸âƒ£ TaskForm.tsx (hardcoded secret):"
          grep -n "API_SECRET_KEY" frontend/src/components/TaskForm.tsx || true
          echo ""
          echo "2ï¸âƒ£ security-test.js (mÃºltiplas vulnerabilidades):"
          if [ -f frontend/src/security-test.js ]; then
            echo "âœ… Arquivo encontrado - vulnerabilidades incluem:"
            grep -n "eval\|innerHTML\|document.write\|Function" frontend/src/security-test.js | head -10
          else
            echo "âŒ Arquivo security-test.js nÃ£o encontrado"
          fi
          
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-extended,security-and-quality
          
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
        
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          upload: true
          
      - name: ğŸš¨ Check for Vulnerabilities
        id: vulnerability_check
        run: |
          echo "ğŸ” VERIFICANDO VULNERABILIDADES DETECTADAS..."
          
          # Verificar se temos os arquivos com vulnerabilidades
          VULN_COUNT=0
          
          if [ -f frontend/src/security-test.js ]; then
            echo "âœ… security-test.js encontrado - vulnerabilidades presentes:"
            if grep -q "eval(" frontend/src/security-test.js; then
              echo "  ğŸš¨ Code Injection (eval) detectado"
              VULN_COUNT=$((VULN_COUNT + 1))
            fi
            if grep -q "innerHTML" frontend/src/security-test.js; then
              echo "  ğŸš¨ XSS (innerHTML) detectado"  
              VULN_COUNT=$((VULN_COUNT + 1))
            fi
            if grep -q "document.write" frontend/src/security-test.js; then
              echo "  ğŸš¨ XSS (document.write) detectado"
              VULN_COUNT=$((VULN_COUNT + 1))
            fi
            if grep -q "new Function" frontend/src/security-test.js; then
              echo "  ğŸš¨ Code Injection (Function constructor) detectado"
              VULN_COUNT=$((VULN_COUNT + 1))
            fi
          fi
          
          if grep -q "sk-live-" frontend/src/components/TaskForm.tsx; then
            echo "  ğŸš¨ Hardcoded Secret detectado"
            VULN_COUNT=$((VULN_COUNT + 1))
          fi
          
          echo "ğŸ“Š Total de padrÃµes vulnerÃ¡veis encontrados: $VULN_COUNT"
          
          if [ $VULN_COUNT -gt 0 ]; then
            echo "ğŸš¨ FALHA DE SEGURANÃ‡A DEMONSTRADA!"
            echo "CodeQL deve ter detectado $VULN_COUNT tipos de vulnerabilidades."
            echo "Verifique a aba Security â†’ Code scanning para detalhes."
            exit 1
          else
            echo "âœ… Nenhuma vulnerabilidade encontrada nos arquivos de teste"
          fi

  gitleaks-demo:
    name: Gitleaks Secret Detection (Manual Demo)  
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'gitleaks-only' || github.event.inputs.scan_type == 'full-security' }}
    steps:
      - name: ğŸ“‹ Demo Info
        run: |
          echo "ğŸ” DEMONSTRAÃ‡ÃƒO GITLEAKS MANUAL"
          echo "ğŸ” Procurando por secrets hardcoded no cÃ³digo"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Mostrar secrets esperados
        run: |
          echo "ğŸ” SECRETS PROPOSITAIS PARA DEMONSTRAÃ‡ÃƒO:"
          echo "1ï¸âƒ£ API Secret Key em TaskForm.tsx:"
          grep -n "API_SECRET_KEY.*sk-live-" frontend/src/components/TaskForm.tsx || true

      - name: Gitleaks Security Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}}

  demo-summary:
    name: ğŸ“Š Demo Summary
    runs-on: ubuntu-latest
    needs: [codeql-demo, gitleaks-demo]
    if: always()
    steps:
      - name: ğŸ“‹ Resumo da DemonstraÃ§Ã£o
        run: |
          echo "ğŸ¯ RESUMO DA DEMONSTRAÃ‡ÃƒO DE SEGURANÃ‡A"
          echo "======================================"
          echo "Tipo de scan: ${{ github.event.inputs.scan_type }}"
          echo ""
          echo "ğŸ“Š RESULTADOS:"
          
          if [[ "${{ needs.codeql-demo.result }}" == "failure" ]]; then
            echo "âŒ CodeQL: VULNERABILIDADES DETECTADAS âœ… (demonstraÃ§Ã£o funcionou)"
          elif [[ "${{ needs.codeql-demo.result }}" == "success" ]]; then
            echo "âœ… CodeQL: Nenhuma vulnerabilidade detectada"
          elif [[ "${{ needs.codeql-demo.result }}" == "skipped" ]]; then
            echo "â­ï¸ CodeQL: NÃ£o executado (tipo de scan: ${{ github.event.inputs.scan_type }})"
          fi
          
          if [[ "${{ needs.gitleaks-demo.result }}" == "failure" ]]; then
            echo "âŒ Gitleaks: SECRETS DETECTADOS âœ… (demonstraÃ§Ã£o funcionou)"
          elif [[ "${{ needs.gitleaks-demo.result }}" == "success" ]]; then
            echo "âœ… Gitleaks: Nenhum secret detectado"
          elif [[ "${{ needs.gitleaks-demo.result }}" == "skipped" ]]; then
            echo "â­ï¸ Gitleaks: NÃ£o executado (tipo de scan: ${{ github.event.inputs.scan_type }})"
          fi
          
          echo ""
          echo "ğŸ” Para ver detalhes das vulnerabilidades:"
          echo "   â€¢ Security tab â†’ Code scanning alerts"
          echo "   â€¢ Security tab â†’ Secret scanning alerts"